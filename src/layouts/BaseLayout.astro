---
import '../styles/global.css'
import { ClientRouter } from 'astro:transitions'
import { languages } from '../i18n'
import { getAbsoluteLocaleUrl } from 'astro:i18n'
interface Props {
  title?: string
  description?: string
}

const { title, description } = Astro.props
const { lang } = Astro.params
const locale = lang != null && lang in languages ? languages[lang].code : 'en-US'
const canonicalUrl = Astro.url.href

// JSON-LD WebSite schema
const websiteSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: 'Timothée Rebours',
  url: 'https://tex0l.github.io',
  author: {
    '@type': 'Person',
    name: 'Timothée Rebours'
  },
  inLanguage: ['en', 'fr']
}
---

<!doctype html>
<html lang={lang}>
<head>
    <meta charset="UTF-8"/>
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="dns-prefetch" href="https://www.seald.io" />

    <meta name="google-site-verification" content="UiqMaJhYDWgjczHPVW5lDDdX6S2b4cnOgsl2gw3ms_4" />
    <meta name="description" content={description}/>
    <meta name="viewport" content="width=device-width"/>
    <meta name='author' content='Timothée Rebours'>
    <link rel="icon" type="image/png" href="/favicon.png"/>
    <link rel="sitemap" href="/sitemap-index.xml" />
    <link rel="canonical" href={canonicalUrl} />
    {Object.keys(languages).map(language =>
      <link rel="alternate" hreflang={languages[language].code} href={getAbsoluteLocaleUrl(language, Astro.url.pathname.substring(3))} />
    )}
    <meta name="generator" content={Astro.generator}/>
    <title>{title}</title>

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:site_name" content="Timothée Rebours" />
    <meta property="og:locale" content={locale.replace('-', '_')} />

    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:creator" content="@ReboursT" />
    <meta name="twitter:site" content="@ReboursT" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />

    <!-- JSON-LD Structured Data -->
    <script is:inline type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />

    <ClientRouter />
    <slot name="head"/>

    <!-- Workaround for astro-mermaid view transitions issue -->
    <script>
      document.addEventListener('astro:page-load', async () => {
        const diagrams = document.querySelectorAll('pre.mermaid:not([data-processed])')
        if (diagrams.length === 0) return

        const { default: mermaid } = await import('mermaid')
        mermaid.initialize({ startOnLoad: false, theme: 'neutral' })

        for (const diagram of diagrams) {
          if (!diagram.getAttribute('data-diagram')) {
            diagram.setAttribute('data-diagram', diagram.textContent || '')
          }
          const definition = diagram.getAttribute('data-diagram') || ''
          const id = 'mermaid-' + Math.random().toString(36).slice(2, 11)
          try {
            const { svg } = await mermaid.render(id, definition)
            diagram.innerHTML = svg
            diagram.setAttribute('data-processed', 'true')
            // Reset code block styling for mermaid diagrams
            diagram.style.backgroundColor = 'transparent'
            diagram.style.padding = '0'
          } catch (e) {
            console.error('[mermaid workaround]', e)
          }
        }
      })
    </script>
</head>
<body>
<slot/>
</body>
</html>
