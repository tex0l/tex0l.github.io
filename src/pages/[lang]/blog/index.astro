---
import { useTranslatedPath, useTranslations, validateLang } from '~/i18n/utils'
import Layout from '~/layouts/Layout.astro'
import { getCollection } from 'astro:content'
import { slugify } from '~/utils/index.ts'
import { languages } from '~/i18n/index.ts'
import { DateTime } from 'luxon'

export function getStaticPaths (): Array<{ params: { lang: string } }> {
  return Object.keys(languages).map(lang => ({ params: { lang } }))
}

const { lang } = Astro.params
validateLang(lang)
const t = useTranslations(lang)
const localizePath = useTranslatedPath(lang)

const blogPosts = (await getCollection('blog', ({ id }) => id.split('/')[0] === lang))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())

const renderedBlogPosts = blogPosts.map(post => {
  const date = DateTime.fromJSDate(post.data.date).setLocale(languages[lang].code)
  return {
    ...post,
    formattedDate: date.toLocaleString({ month: 'long', year: 'numeric' }),
    formattedAbsoluteDate: date.toLocaleString(DateTime.DATE_FULL)
  }
})
---

<Layout title={t('blog.title')}>
    <slot slot="head">
        <meta property="og:type" content="website" />
    </slot>

    <div class="max-w-2xl mx-auto px-4 sm:px-6 py-16">
        <!-- Page Header -->
        <header class="mb-16">
            <h1 class="text-4xl font-semibold tracking-tight mb-4">
                {t('blog.h1')}
            </h1>
            <p class="text-[--color-text-secondary] text-lg leading-relaxed">
                {t('blog.subtitle')}
            </p>
        </header>

        <!-- Blog Posts List -->
        <div class="divide-y divide-[--color-border]">
            {renderedBlogPosts.map(post => (
                <article class="py-8 first:pt-0">
                    <a href={localizePath(`/blog/${slugify(post.id)}`)} class="group block">
                        <time
                            class="text-sm uppercase tracking-wider text-[--color-text-muted] mb-2 block"
                            datetime={post.data.date.toISOString()}
                            title={post.formattedAbsoluteDate}
                        >
                            {post.formattedDate}
                        </time>
                        <h2 class="text-xl font-semibold text-[--color-text-primary] group-hover:text-[--color-text-secondary] mb-2">
                            {post.data.title}
                        </h2>
                        {post.data.description && (
                            <p class="text-[--color-text-secondary] leading-relaxed line-clamp-2">
                                {post.data.description}
                            </p>
                        )}
                    </a>
                </article>
            ))}
        </div>
    </div>
</Layout>
