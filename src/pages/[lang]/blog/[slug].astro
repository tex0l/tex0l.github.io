---
import { convertMDXToHTML } from '~/utils/mdxToHtml'
import { languages } from '~/i18n'
import {
  validateLang
} from '~/i18n/utils'
import { Picture } from 'astro:assets'
import Layout from '~/layouts/Layout.astro'
import { getCollection, type CollectionEntry } from 'astro:content'
import { slugify } from '~/utils'
import sanitizeHtml from 'sanitize-html'
import { DateTime } from 'luxon'

export async function getStaticPaths (): Promise<Array<{ params: { lang: string, slug: string }, props: { post: CollectionEntry<'blog'> } }>> {
  const blogEntries = await getCollection('blog')
  return Object.keys(languages).flatMap(lang => {
    return blogEntries
      .filter(entry => entry.id.split('/')[0] === lang)
      .map(entry => ({
        params: { slug: slugify(entry.id), lang },
        props: { post: entry }
      }))
  })
}
interface Props {
  post: CollectionEntry<'blog'>
}

// eslint-disable-next-line @typescript-eslint/no-unnecessary-type-assertion
const { post } = Astro.props as Props
const { Content } = await post.render()
const { lang } = Astro.params
validateLang(lang)

const truncatedPost = sanitizeHtml(await convertMDXToHTML(post.body, 297), { allowedTags: [] })

const date = DateTime.fromJSDate(post.data.date).setLocale(languages[lang].code)
const formattedDate = date.toLocaleString({ month: 'long', year: 'numeric' })
const formattedAbsoluteDate = date.toLocaleString(DateTime.DATE_FULL)
---

<Layout title={post.data.title} description={post.data.description ?? `${truncatedPost}...`}>
    <Fragment slot="head">
        <meta property="og:type" content="article"/>
        <meta property="og:image" content={`${Astro.url.origin}/og/blog-${lang}-${slugify(post.id)}.png`} />
    </Fragment>

    <article class="max-w-2xl mx-auto px-4 sm:px-6 py-16">
        <!-- Article Header -->
        <header class="text-center mb-12">
            <time
                class="text-sm uppercase tracking-wider text-[--color-text-muted] mb-4 block"
                datetime={post.data.date.toISOString()}
                title={formattedAbsoluteDate}
            >
                {formattedDate}
            </time>
            <h1 class="text-3xl sm:text-4xl font-semibold tracking-tight leading-tight mb-4">
                {post.data.title}
            </h1>
            {post.data.description && (
                <p class="text-lg text-[--color-text-secondary] leading-relaxed">
                    {post.data.description}
                </p>
            )}
        </header>

        <!-- Separator -->
        <div class="flex justify-center mb-12">
            <span class="text-[--color-text-muted]">———</span>
        </div>

        <!-- Featured Image -->
        {post.data.image != null && (
            <figure class="mb-12 -mx-4 sm:mx-0">
                <Picture
                    src={post.data.image}
                    alt={post.data.alt}
                    width="1200"
                    class="w-full rounded-lg"
                />
            </figure>
        )}

        <!-- Article Content -->
        <div class="prose prose-lg max-w-none prose-headings:font-semibold prose-headings:tracking-tight prose-headings:scroll-mt-20 prose-a:text-[--color-accent] prose-a:underline prose-a:underline-offset-2 hover:prose-a:text-[--color-text-secondary] [&_h1>a]:no-underline [&_h2>a]:no-underline [&_h3>a]:no-underline [&_h4>a]:no-underline [&_h5>a]:no-underline [&_h6>a]:no-underline">
            <Content/>
        </div>
    </article>
</Layout>
