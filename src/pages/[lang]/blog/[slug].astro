---
import { convertMDXToHTML } from '~/utils/mdxToHtml'
import { languages } from '~/i18n'
import {
  validateLang,
  useTranslations,
  useTranslatedPath
} from '~/i18n/utils'
import { Picture } from 'astro:assets'
import Layout from '~/layouts/Layout.astro'
import { getCollection, type CollectionEntry } from 'astro:content'
import { slugify } from '~/utils'
import { createBreadcrumbSchema } from '~/utils/breadcrumb'
import sanitizeHtml from 'sanitize-html'
import { DateTime } from 'luxon'

export async function getStaticPaths (): Promise<Array<{ params: { lang: string, slug: string }, props: { post: CollectionEntry<'blog'> } }>> {
  const blogEntries = await getCollection('blog')
  return Object.keys(languages).flatMap(lang => {
    return blogEntries
      .filter(entry => entry.id.split('/')[0] === lang)
      .map(entry => ({
        params: { slug: slugify(entry.id), lang },
        props: { post: entry }
      }))
  })
}
interface Props {
  post: CollectionEntry<'blog'>
}

// eslint-disable-next-line @typescript-eslint/no-unnecessary-type-assertion
const { post } = Astro.props as Props
const { Content } = await post.render()
const { lang } = Astro.params
validateLang(lang)
const t = useTranslations(lang)
const localizePath = useTranslatedPath(lang)

const truncatedPost = sanitizeHtml(await convertMDXToHTML(post.body, 297), { allowedTags: [] })

const date = DateTime.fromJSDate(post.data.date).setLocale(languages[lang].code)
const formattedDate = date.toLocaleString({ month: 'long', year: 'numeric' })
const formattedAbsoluteDate = date.toLocaleString(DateTime.DATE_FULL)

const updatedDate = post.data.updatedDate != null ? DateTime.fromJSDate(post.data.updatedDate).setLocale(languages[lang].code) : null
const formattedUpdatedDate = updatedDate?.toLocaleString({ month: 'long', year: 'numeric' })
// eslint-disable-next-line @typescript-eslint/no-unsafe-assignment -- Content collection types not resolved by astro-eslint-parser
const modifiedDate: Date = post.data.updatedDate ?? post.data.date

// JSON-LD Article schema
const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: post.data.title,
  description: post.data.description ?? truncatedPost,
  image: post.data.image != null ? `${Astro.url.origin}/og/blog-${lang}-${slugify(post.id)}.png` : undefined,
  datePublished: post.data.date.toISOString(),
  dateModified: modifiedDate.toISOString(),
  author: {
    '@type': 'Person',
    name: 'Timothée Rebours',
    url: 'https://tex0l.github.io'
  },
  publisher: {
    '@type': 'Person',
    name: 'Timothée Rebours'
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': Astro.url.href
  },
  inLanguage: languages[lang].code
}

const breadcrumbSchema = createBreadcrumbSchema(lang, Astro.url.origin, [
  { name: t('blog.title'), url: localizePath('/blog') },
  { name: post.data.title }
])
---

<Layout title={post.data.title} description={post.data.description ?? `${truncatedPost}...`}>
    <Fragment slot="head">
        <meta property="og:type" content="article"/>
        <meta property="og:image" content={`${Astro.url.origin}/og/blog-${lang}-${slugify(post.id)}.png`} />
        <meta name="twitter:image" content={`${Astro.url.origin}/og/blog-${lang}-${slugify(post.id)}.png`} />
        <meta property="article:published_time" content={post.data.date.toISOString()} />
        {post.data.updatedDate != null && <meta property="article:modified_time" content={post.data.updatedDate.toISOString()} />}
        <script is:inline type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
        <script is:inline type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
    </Fragment>

    <article class="max-w-2xl mx-auto px-4 sm:px-6 py-16">
        <!-- Article Header -->
        <header class="text-center mb-12">
            <div class="text-sm uppercase tracking-wider text-[--color-text-muted] mb-4">
                <time datetime={post.data.date.toISOString()} title={formattedAbsoluteDate}>
                    {formattedDate}
                </time>
                {formattedUpdatedDate != null && (
                    <span class="block mt-1 text-xs normal-case">
                        {t('blog.updated')}{formattedUpdatedDate}
                    </span>
                )}
            </div>
            <h1 class="text-3xl sm:text-4xl font-semibold tracking-tight leading-tight mb-4">
                {post.data.title}
            </h1>
            {post.data.description && (
                <p class="text-lg text-[--color-text-secondary] leading-relaxed">
                    {post.data.description}
                </p>
            )}
        </header>

        <!-- Separator -->
        <div class="flex justify-center mb-12">
            <span class="text-[--color-text-muted]">———</span>
        </div>

        <!-- Featured Image -->
        {post.data.image != null && (
            <figure class="mb-12 -mx-4 sm:mx-0">
                <Picture
                    src={post.data.image}
                    alt={post.data.alt}
                    width="1200"
                    class="w-full rounded-lg"
                    loading="eager"
                    fetchpriority="high"
                />
            </figure>
        )}

        <!-- Article Content -->
        <div class="prose prose-lg max-w-none prose-headings:font-semibold prose-headings:tracking-tight prose-headings:scroll-mt-20 prose-a:text-[--color-accent] prose-a:underline prose-a:underline-offset-2 hover:prose-a:text-[--color-text-secondary] [&_h1>a]:no-underline [&_h2>a]:no-underline [&_h3>a]:no-underline [&_h4>a]:no-underline [&_h5>a]:no-underline [&_h6>a]:no-underline">
            <Content/>
        </div>
    </article>
</Layout>
